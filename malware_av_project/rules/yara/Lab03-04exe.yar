import "pe"
import "hash"

rule Lab03_04_Win32_Service_Backdoor
{
    meta:
        author      = "Malwareaqqq"
        description = "Win32 EXE malware with service persistence, registry modification and network communication"
        date        = "2025-12-16"

        md5     = "b94af4a4d4af6eac81fc135abda1c40c"
        sha1    = "d6356b2c6f8d29f8626062b5aefb13b7fc744d54"
        sha256  = "6ac06dfa543dca43327d55a61d0aaed25f3c90cce791e0555e3e306d47107859"

        file_size = "61440"
        compiler  = "Microsoft Visual C++ 6.0"
        platform  = "Win32"

    strings:
        /* Service persistence */
        $svc1 = "CreateServiceA" ascii
        $svc2 = "OpenSCManagerA" ascii
        $svc3 = "ChangeServiceConfigA" ascii
        $svc4 = "DeleteService" ascii

        /* Registry modification */
        $reg1 = "RegCreateKeyExA" ascii
        $reg2 = "RegQueryValueExA" ascii
        $reg3 = "RegDeleteValueA" ascii

        /* Network communication */
        $net1 = "socket" ascii
        $net2 = "connect" ascii
        $net3 = "send" ascii
        $net4 = "recv" ascii

        /* File & execution */
        $file1 = "CopyFileA" ascii
        $file2 = "DeleteFileA" ascii
        $exec1 = "ShellExecuteA" ascii

    condition:
        /* PE basic validation */
        uint16(0) == 0x5A4D and
        pe.is_pe and
        pe.is_32bit() and
        (pe.characteristics & 0x2000) == 0 and   // not DLL

        /* File size */
        filesize == 61440 and

        /* Section layout */
        pe.number_of_sections == 3 and
        pe.sections[0].name == ".text" and
        pe.sections[1].name == ".rdata" and
        pe.sections[2].name == ".data" and

        /* Behavior-based detection */
        (
            (2 of ($svc*)) or
            (1 of ($reg*) and 2 of ($net*)) or
            (1 of ($file*) and $exec1)
        ) and

        /* Strong confirmation */
        hash.sha256(0, filesize) ==
        "6ac06dfa543dca43327d55a61d0aaed25f3c90cce791e0555e3e306d47107859"
}
