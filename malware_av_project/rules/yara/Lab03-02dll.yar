import "pe"
import "hash"

rule Lab03_02_Win32_Service_DLL
{
    meta:
        author = "Malwareaqqq"
        description = "Win32 malicious DLL with service installation and network communication capability"
        date = "2025-12-16"

        md5    = "84882c9d43e23d63b82004fae74ebb61"
        sha1   = "c6fb3b50d946bec6f391aefa4e54478cf8607211"
        sha256 = "5eced7367ed63354b4ed5c556e2363514293f614c2c2eb187273381b2ef5f0f9"

        file_size = "24065"
        compiler  = "Microsoft Visual C/C++ 6.0"
        platform  = "Win32"

    strings:
        /* Service-related exports */
        $exp_install   = "Install" ascii
        $exp_service   = "ServiceMain" ascii
        $exp_uninstall = "UninstallService" ascii

        /* Service & registry APIs */
        $svc1 = "CreateServiceA" ascii
        $svc2 = "OpenSCManagerA" ascii
        $svc3 = "RegisterServiceCtrlHandlerA" ascii
        $reg1 = "RegCreateKeyA" ascii
        $reg2 = "RegQueryValueExA" ascii

        /* Network & C2 communication */
        $net1 = "InternetOpenA" ascii
        $net2 = "HttpSendRequestA" ascii
        $net3 = "connect" ascii
        $net4 = "recv" ascii
        $net5 = "send" ascii

    condition:
        uint16(0) == 0x5A4D and
        pe.is_pe and
        (pe.characteristics & 0x2000) != 0 and   // DLL
        pe.is_32bit() and

        filesize == 24065 and

        pe.number_of_sections == 4 and
        pe.exports("ServiceMain") and

        /* 引用所有 export */
        1 of ($exp*) and

        /* 服务+注册表匹配（引用 $reg2） */
        (($svc1 and $svc2 and $svc3 and 1 of ($reg*)) 
        or
        (2 of ($net*))) and

        hash.sha256(0, filesize) == "5eced7367ed63354b4ed5c556e2363514293f614c2c2eb187273381b2ef5f0f9"
}
