import "pe"
import "hash"

rule Lab03_03_Malicious_EXE
{
    meta:
        description = "Detects Lab03-03.exe malware sample (XORCrypt, persistence, anti-debug)"
        author = "Malwareaqqq"
        date = "2026-01-06"
        reference = "VirusTotal SHA256: ae8a1c7eb64c42ea2a04f97523ebf0844c27029eb040d910048b680f884b9dce"
        hash_sha256 = "ae8a1c7eb64c42ea2a04f97523ebf0844c27029eb040d910048b680f884b9dce"

    strings:
        /* 样本常见历史名称 */
        $name1 = "Lab03-03.exe" ascii nocase
        $name2 = "Keylog.exe" ascii nocase
        $name3 = "Sample1.exe" ascii nocase

        /* 关键可疑 API（文件操作 / 进程创建 / 资源释放） */
        $api1 = "CreateFileA" ascii
        $api2 = "CreateProcessA" ascii
        $api3 = "FindResourceA" ascii
        $api4 = "FreeResource" ascii
        $api5 = "GetCommandLineA" ascii

        /* PE 通用 DOS Stub */
        $mz = "This program cannot be run in DOS mode" ascii

    condition:
        /* 必须是 32 位 Windows EXE（不是 DLL） */
        uint16(0) == 0x5A4D and
        pe.machine == pe.MACHINE_I386 and
        not pe.is_dll() and

        (
            /* 精确 SHA256 哈希匹配 */
            hash.sha256(0, filesize) ==
                "ae8a1c7eb64c42ea2a04f97523ebf0844c27029eb040d910048b680f884b9dce"

            or

            /* 或 字符串 + API 行为特征匹配 */
            (
                1 of ($name*) and
                3 of ($api*) and
                $mz
            )
        )
}
