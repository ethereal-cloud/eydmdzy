rule Lab07_03_DLL {
    meta:
        description = "Detects Lab07-03.dll - Remote access backdoor with C&C communication"
        
    strings:
        // C&C服务器IP地址
        $s1 = "127.26.152.13" ascii
        
        // 握手信标
        $s2 = "hello" ascii
        
        // 远程命令
        $s3 = "sleep" ascii
        $s4 = "exec" ascii
        
        // 互斥量名称（单实例控制）
        $s5 = "SADFHUHF" ascii wide
        
        // 网络通信API
        $api1 = "WSAStartup" ascii
        $api2 = "socket" ascii
        $api3 = "connect" ascii
        $api4 = "send" ascii
        $api5 = "recv" ascii
        
        // 进程创建API
        $api6 = "CreateProcessA" ascii
        
        // 互斥量API
        $api7 = "CreateMutexA" ascii
        
    condition:
        uint16(0) == 0x5A4D and
        uint32(uint32(0x3C)) == 0x00004550 and
        (
            ($s1 and $s5) or
            ($s1 and $s2 and ($s3 or $s4)) or
            ($s5 and $s2 and ($s3 or $s4)) or
            ($s1 and 3 of ($api*) and $api6) or
            ($s5 and $api7 and 2 of ($s2, $s3, $s4))
        )
}