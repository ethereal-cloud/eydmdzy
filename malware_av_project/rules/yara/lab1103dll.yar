rule Lab11_03_dll {
    meta:
        description = "检测Lab11-03.dll键盘记录器DLL"
        
    strings:
        // 特殊导出函数名
        $str_export = "zzz69806582" ascii
        
        // 键盘记录日志文件
        $str_log_file = "kernel64x.dll" ascii wide
        
        // 特殊按键标识字符串
        $key_shift = "<SHIFT>" ascii wide
        $key_backspace = "<BACKSPACE>" ascii wide
        
        // 键盘记录核心API
        $api_async_key = "GetAsyncKeyState" ascii
        $api_foreground = "GetForegroundWindow" ascii
        
        // 互斥体操作
        $api_create_mutex = "CreateMutexA" ascii
        $api_open_mutex = "OpenMutexA" ascii
        
        // 文件操作
        $api_write_file = "WriteFile" ascii
        
    condition:
        uint16(0) == 0x5A4D and
        filesize < 50KB and
        (
            // 特殊导出函数名
            $str_export or
            // 日志文件路径
            $str_log_file or
            // 键盘记录API组合
            ($api_async_key and $api_foreground) or
            // 特殊按键字符串
            ($key_shift and $key_backspace) or
            // 互斥体 + 文件写入
            (($api_create_mutex or $api_open_mutex) and $api_write_file)
        )
}
