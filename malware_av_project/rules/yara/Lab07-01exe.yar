import "pe"

rule Lab07_01_Win32_Service_HTTP_Backdoor
{
    meta:
        author = "Malwareaqqq"
        description = "Win32 EXE malware with service persistence, thread/timer control and HTTP communication"
        date = "2025-12-16"

        sample_sha256 = "0c98769e42b364711c478226ef199bfbba90db80175eb1b8cd565aa694c09852"

    strings:
        /* Thread / mutex / timer */
        $sync1 = "CreateMutexA" ascii
        $sync2 = "CreateThread" ascii
        $sync3 = "CreateWaitableTimerA" ascii

        /* Service persistence */
        $svc1 = "CreateServiceA" ascii
        $svc2 = "OpenSCManagerA" ascii
        $svc3 = "StartServiceCtrlDispatcherA" ascii

        /* HTTP communication */
        $http1 = "InternetOpenA" ascii
        $http2 = "InternetOpenUrlA" ascii

    condition:
        /* PE EXE */
        uint16(0) == 0x5A4D and
        pe.is_pe and
        pe.is_32bit() and
        (pe.characteristics & 0x2000) == 0 and

        /* Strong structural fingerprint */
        filesize == 24576 and
        pe.number_of_sections == 3 and
        pe.sections[0].name == ".text" and
        pe.sections[1].name == ".rdata" and
        pe.sections[2].name == ".data" and

        /* Behavior-level detection */
        (
            (2 of ($svc*)) or
            (2 of ($sync*)) or
            (2 of ($http*))
        )
}
