rule Lab13_03_AES_Backdoor
{
    meta:
        description = "Detects Lab13-03.exe - AES encrypted reverse shell with custom Base64"
        author = "Malware Analysis Lab"
        date = "2025-01"
        hash = "Lab13-03.exe"
        reference = "Nankai University Malware Analysis Course"
        threat_type = "Backdoor/Reverse Shell"
        
    strings:
        // === High confidence indicators (unique to this malware) ===
        // Custom Base64 table (rotated alphabet) - very specific
        $custom_base64 = "CDEFGHIJKLMNOPQRSTUVWXYZABcdefghijklmnopqrstuvwxyzab0123456789+/" ascii
        
        // Hardcoded AES key - very specific
        $aes_key = "ijklmnopqrstuvwx" ascii
        
        // C2 domain - definitive indicator
        $c2_domain = "www.practicalmalwareanalysis.com" ascii
        
        // === Medium confidence indicators ===
        // AES error messages combination
        $err1 = "Empty key" ascii
        $err2 = "Incorrect key length" ascii
        $err3 = "Incorrect block length" ascii
        $err4 = "Object not Initialized" ascii
        
        // Rijndael S-box (first 16 bytes)
        $sbox = { 63 7C 77 7B F2 6B 6F C5 30 01 67 2B FE D7 AB 76 }
        
        // === Low confidence indicators (common but relevant) ===
        $cmd = "cmd.exe" ascii wide
        
        // Network APIs
        $net1 = "WSAStartup" ascii
        $net2 = "connect" ascii
        
        // Process APIs
        $api1 = "CreatePipe" ascii
        $api2 = "CreateProcess" ascii

    condition:
        uint16(0) == 0x5A4D and
        filesize < 500KB and
        (
            // Scenario 1: Any high-confidence unique indicator
            $custom_base64 or
            $aes_key or
            $c2_domain or
            
            // Scenario 2: Multiple medium indicators together (AES errors + S-box)
            (3 of ($err*) and $sbox) or
            
            // Scenario 3: S-box + cmd + network + process APIs (backdoor behavior)
            ($sbox and $cmd and all of ($net*) and all of ($api*))
        )
}
