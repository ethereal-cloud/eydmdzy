import "pe"
import "hash"

rule Lab12_04_Malicious_EXE
{
    meta:
        description = "Detects Practical Malware Analysis Lab12-04.exe sample"
        author = "Malwareaqqq"
        date = "2026-01-06"
        reference = "VirusTotal SHA256: e2aed4398e0178670d9678961ca89a0f15a3eac20f396bdf29de8ac66cb853fa"
        hash_sha256 = "e2aed4398e0178670d9678961ca89a0f15a3eac20f396bdf29de8ac66cb853fa"

    strings:
        /* 样本常见历史文件名 */
        $name1 = "Lab12-04.exe" ascii nocase
        $name2 = "Malware 4.exe" ascii nocase
        $name3 = "Monitor-5.exe" ascii nocase

        /* 远程线程注入相关 API */
        $inj1 = "CreateRemoteThread" ascii
        $inj2 = "GetProcAddress" ascii
        $inj3 = "LoadLibraryA" ascii

        /* 资源与文件操作 */
        $res1 = "FindResourceA" ascii
        $res2 = "CreateFileA" ascii

        /* 权限提升相关 API */
        $priv1 = "OpenProcessToken" ascii
        $priv2 = "AdjustTokenPrivileges" ascii
        $priv3 = "LookupPrivilegeValueA" ascii

        /* PE DOS Stub */
        $mz = "This program cannot be run in DOS mode" ascii

    condition:
        /* 32 位 Windows EXE（非 DLL） */
        uint16(0) == 0x5A4D and
        pe.machine == pe.MACHINE_I386 and
        not pe.is_dll() and

        (
            /* 精确哈希匹配 */
            hash.sha256(0, filesize) ==
                "e2aed4398e0178670d9678961ca89a0f15a3eac20f396bdf29de8ac66cb853fa"

            or

            /* 行为特征组合匹配 */
            (
                1 of ($name*) and
                all of ($inj*) and
                1 of ($res*) and
                1 of ($priv*) and
                $mz
            )
        )
}
