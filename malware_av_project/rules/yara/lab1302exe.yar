rule Lab13_02_Screenshot_Encryptor
{
    meta:
        description = "Detects Lab13-02.exe - Screenshot capture with custom encryption"
        author = "Malware Analysis Lab"
        date = "2025-01"
        hash = "Lab13-02.exe"
        reference = "Nankai University Malware Analysis Course"
        threat_type = "Spyware/Screenshot Capture"
        
    strings:
        // Temporary file naming pattern
        $temp_format = "temp%08x" ascii wide
        
        // Screenshot capture APIs
        $api1 = "GetDesktopWindow" ascii
        $api2 = "GetSystemMetrics" ascii
        $api3 = "GetDC" ascii
        $api4 = "CreateCompatibleDC" ascii
        $api5 = "CreateCompatibleBitmap" ascii
        $api6 = "BitBlt" ascii
        $api7 = "GetDIBits" ascii
        $api8 = "SelectObject" ascii
        
        // Memory management APIs
        $api9 = "GlobalAlloc" ascii
        $api10 = "GlobalLock" ascii
        $api11 = "GlobalUnlock" ascii
        $api12 = "GlobalFree" ascii
        
        // Time-based naming
        $api13 = "GetTickCount" ascii
        
    condition:
        uint16(0) == 0x5A4D and  // MZ header
        filesize < 100KB and
        $temp_format and
        4 of ($api1, $api2, $api3, $api4, $api5, $api6, $api7, $api8) and
        2 of ($api9, $api10, $api11, $api12) and
        $api13
}

rule Lab13_02_Custom_Encryption
{
    meta:
        description = "Detects custom encryption routine in Lab13-02"
        author = "Malware Analysis Lab"
        threat_type = "Custom Encryption"
        
    strings:
        // Temporary file naming pattern (anchor string)
        $temp_format = "temp%08x" ascii
        
        // Screenshot related APIs as anchors
        $api1 = "GetDesktopWindow" ascii
        $api2 = "BitBlt" ascii
        $api3 = "GetDIBits" ascii
        $api4 = "WriteFile" ascii
        
    condition:
        uint16(0) == 0x5A4D and
        $temp_format and
        3 of ($api*)
}