import "pe"
import "hash"

rule Lab03_03_Win32_Keylogger_EXE
{
    meta:
        author = "Malwareaqqq"
        description = "Win32 EXE malware sample compiled with Visual C++, suspected keylogging functionality"
        date = "2025-12-16"

        md5 = "e2bf42217a67e46433da8b6f4507219e"
        sha1 = "daf263702f11dc0430d30f9bf443e7885cf91fcb"
        sha256 = "ae8a1c7eb64c42ea2a04f97523ebf0844c27029eb040d910048b680f884b9dce"

        file_size = "53248 bytes"
        compiler = "Microsoft Visual C++ 6.0"
        file_type = "Win32 EXE (Console)"

    strings:
        /* File & process manipulation */
        $api_createfile = "CreateFileA" ascii
        $api_createproc = "CreateProcessA" ascii
        $api_exit = "ExitProcess" ascii

        /* Environment & execution context */
        $api_cmdline = "GetCommandLineA" ascii
        $api_getacp = "GetACP" ascii

        /* Known filenames */
        $name1 = "Keylog.exe" nocase
        $name2 = "Lab03-03.exe" nocase
        $name3 = "key.exe" nocase

    condition:
        uint16(0) == 0x5A4D and
        pe.is_pe and
        pe.is_32bit() and
        (pe.characteristics & 0x2000) == 0 and  // not DLL
        filesize == 53248 and
        pe.number_of_sections == 4 and
        pe.sections[0].name == ".text" and
        pe.sections[1].name == ".rdata" and
        pe.sections[2].name == ".data" and
        pe.sections[3].name == ".rsrc" and

        /* Behavioral indicators */
        (
            ($api_createfile and $api_createproc)
            or
            ($api_cmdline and $api_getacp)
            or
            $api_exit
            or
            1 of ($name*)
        ) and

        /* Strong confirmation */
        hash.sha256(0, filesize) == "ae8a1c7eb64c42ea2a04f97523ebf0844c27029eb040d910048b680f884b9dce"
}
