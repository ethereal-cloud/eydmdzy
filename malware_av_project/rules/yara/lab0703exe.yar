rule Lab07_03_EXE {
    meta:
        description = "Detects Lab07-03.exe - PE file infector and DLL dropper"
        
    strings:
        // 伪装的DLL名称（数字1替代字母l）
        $s1 = "kerne132.dll" ascii wide nocase
        
        // 反调试命令行参数
        $s2 = "WARNING_THIS_WILL_DESTROY_YOUR_MACHINE" ascii
        
        // 恶意DLL部署路径
        $s3 = "C:\\Windows\\System32\\kerne132.dll" ascii wide nocase
        
        // 原始DLL文件名
        $s4 = "Lab07-03.dll" ascii wide
        
        // 文件遍历通配符
        $s5 = "C:\\*" ascii
        
        // 目标文件扩展名
        $s6 = ".exe" ascii
        
        // 关键API函数
        $api1 = "CreateFileMappingA" ascii
        $api2 = "MapViewOfFile" ascii
        $api3 = "FindFirstFileA" ascii
        $api4 = "CopyFileA" ascii
        
    condition:
        uint16(0) == 0x5A4D and
        uint32(uint32(0x3C)) == 0x00004550 and
        (
            ($s1 and $s2) or
            ($s1 and $s3) or
            ($s2 and 2 of ($api*)) or
            ($s1 and $s4) or
            ($s1 and $s5 and $s6 and 2 of ($api*))
        )
}