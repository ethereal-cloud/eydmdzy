rule Lab13_01_XOR_Base64_Backdoor
{
    meta:
        description = "Detects Lab13-01.exe - XOR encrypted C2 with Base64 encoding"
        author = "Malware Analysis Lab"
        date = "2025-01"
        hash = "Lab13-01.exe"
        reference = "Nankai University Malware Analysis Course"
        threat_type = "Backdoor/C2 Communication"
        
    strings:
        // Standard Base64 encoding table
        $base64_table = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/" ascii wide
        
        // HTTP URL format string used for C2 communication
        $url_format = "http://%s/%s/" ascii wide
        
        // Mozilla User-Agent string
        $user_agent = "Mozilla/4.0" ascii wide
        
        // XOR encryption with key 0x3B pattern
        $xor_key_pattern1 = { 83 F0 3B }  // xor eax, 3Bh
        $xor_key_pattern2 = { 34 3B }     // xor al, 3Bh
        $xor_key_pattern3 = { 80 F? 3B }  // xor reg8, 3Bh
        
        // Resource type RT_RCDATA (0x0A) and ID 101 (0x65)
        $resource_access = { 6A 0A [0-8] 6A 65 }  // push 0Ah; ... push 65h
        
        // Network API imports
        $api1 = "InternetOpenA" ascii
        $api2 = "InternetOpenUrlA" ascii
        $api3 = "InternetReadFile" ascii
        $api4 = "InternetCloseHandle" ascii
        
        // Resource manipulation APIs
        $api5 = "FindResourceA" ascii
        $api6 = "LoadResource" ascii
        $api7 = "LockResource" ascii
        $api8 = "SizeofResource" ascii
        
        // Hostname retrieval for beacon
        $api9 = "gethostname" ascii
        
    condition:
        uint16(0) == 0x5A4D and  // MZ header
        filesize < 100KB and
        $base64_table and
        $url_format and
        ($user_agent or $api9) and
        (1 of ($xor_key_pattern*) or $resource_access) and
        2 of ($api1, $api2, $api3, $api4) and
        2 of ($api5, $api6, $api7, $api8)
}

rule Lab13_01_XOR_Decryption_Loop
{
    meta:
        description = "Detects XOR decryption loop pattern in Lab13-01"
        author = "Malware Analysis Lab"
        threat_type = "Encryption Routine"
        
    strings:
        // XOR decryption loop pattern with key 0x3B
        $xor_loop1 = { 8A 02 [0-4] 83 F0 3B [0-4] 88 01 }
        $xor_loop2 = { 8A [1-2] 34 3B [0-4] 88 }
        
        // XOR with immediate 0x3B
        $xor_imm = { 35 3B 00 00 00 }  // xor eax, 0000003Bh
        
    condition:
        uint16(0) == 0x5A4D and
        any of them
}