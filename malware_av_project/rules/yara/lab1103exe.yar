rule Lab11_03_exe {
    meta:
        description = "检测Lab11-03.exe PE感染型键盘记录器安装器"
        
    strings:
        // 释放的DLL文件名
        $str_inet_epar = "inet_epar32.dll" ascii wide
        
        // 感染目标和启动命令
        $str_cisvc = "cisvc.exe" ascii wide
        $str_net_start = "net start cisvc" ascii wide
        
        // DLL导出函数名
        $str_export = "zzz69806582" ascii
        
        // PE内存映射操作API
        $api_create_mapping = "CreateFileMappingA" ascii
        $api_map_view = "MapViewOfFile" ascii
        $api_unmap_view = "UnmapViewOfFile" ascii
        $api_copy_file = "CopyFileA" ascii
        
        // Shellcode重定位标记
        $shellcode_marker = { 78 56 34 18 }
        
    condition:
        uint16(0) == 0x5A4D and
        filesize < 100KB and
        (
            // DLL释放 + 服务启动
            ($str_inet_epar and $str_cisvc and $str_net_start) or
            // PE感染特征
            ($api_create_mapping and $api_map_view and $api_unmap_view) or
            // Shellcode特征
            ($shellcode_marker and $str_export) or
            // 文件复制 + 目标DLL
            ($api_copy_file and $str_inet_epar)
        )
}
