rule Lab11_02_dll {
    meta:
        description = "检测Lab11-02.dll邮件窃取DLL"
        
    strings:
        // 唯一导出函数
        $export_installer = "installer" ascii
        
        // 目标邮件客户端进程
        $proc_outlook = "OUTLOOK.EXE" ascii wide
        $proc_thebat = "THEBAT.EXE" ascii wide
        $proc_msimn = "MSIMN.EXE" ascii wide
        
        // SMTP协议特征
        $str_rcpt = "RCPT TO:" ascii wide
        
        // 网络库和函数
        $str_wsock = "wsock32.dll" ascii wide
        $str_send = "send" ascii
        
        // 持久化相关
        $str_appinit = "AppInit_DLLs" ascii wide
        $str_spoolvxx = "spoolvxx32.dll" ascii wide
        
        // 配置文件
        $str_ini = "Lab11-02.ini" ascii wide
        
        // Inline Hook相关API
        $api_virtual_protect = "VirtualProtect" ascii
        
        // 线程操作API
        $api_snapshot = "CreateToolhelp32Snapshot" ascii
        $api_suspend = "SuspendThread" ascii
        
    condition:
        uint16(0) == 0x5A4D and
        filesize < 50KB and
        (
            // installer导出 + AppInit持久化
            ($export_installer and $str_appinit and $str_spoolvxx) or
            // 邮件客户端目标 + SMTP
            (2 of ($proc_outlook, $proc_thebat, $proc_msimn) and $str_rcpt) or
            // 网络钩子特征
            ($str_wsock and $str_send and $api_virtual_protect) or
            // 配置文件 + 线程操作
            ($str_ini and ($api_snapshot or $api_suspend))
        )
}