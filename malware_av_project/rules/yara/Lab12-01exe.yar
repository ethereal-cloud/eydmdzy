import "pe"
import "hash"

rule Lab12_01_Malicious_EXE
{
    meta:
        description = "Detects Practical Malware Analysis Lab12-01.exe sample"
        author = "Malwareaqqq"
        date = "2026-01-06"
        reference = "VirusTotal SHA256: 1fb3c4a9109ef171fa67bdf90e67f09ef25b5a1d401dc20dc45cfccf1e4fbd99"
        hash_sha256 = "1fb3c4a9109ef171fa67bdf90e67f09ef25b5a1d401dc20dc45cfccf1e4fbd99"

    strings:
        /* 样本历史名称 */
        $name1 = "Lab12-01.exe" ascii nocase
        $name2 = "victim.exe" ascii nocase
        $name3 = "inclass7.malware" ascii nocase

        /* 关键可疑 API（进程注入 / 启动行为） */
        $api1 = "CreateRemoteThread" ascii
        $api2 = "GetCurrentProcess" ascii
        $api3 = "FreeEnvironmentStringsA" ascii
        $api4 = "GetCommandLineA" ascii

        /* PE 通用特征 */
        $mz = "This program cannot be run in DOS mode" ascii

    condition:
        /* 必须是 32 位 Windows EXE（不是 DLL） */
        uint16(0) == 0x5A4D and
        pe.machine == pe.MACHINE_I386 and
        not pe.is_dll() and

        (
            /* 精确哈希匹配 */
            hash.sha256(0, filesize) ==
                "1fb3c4a9109ef171fa67bdf90e67f09ef25b5a1d401dc20dc45cfccf1e4fbd99"

            or

            /* 行为 + 字符串特征匹配 */
            (
                1 of ($name*) and
                2 of ($api*) and
                $mz
            )
        )
}
