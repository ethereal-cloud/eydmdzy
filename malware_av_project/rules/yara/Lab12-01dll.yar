import "pe"
import "hash"

rule Lab12_01_Malicious_DLL
{
    meta:
        description = "Detects Practical Malware Analysis Lab12-01.dll sample"
        author = "Malwareaqqq"
        reference = "VirusTotal SHA256: 0ea89a83b84b8d20e259bacb6b0d1b176c8327f097c54749ae832981f2a0095a"
        date = "2026-01-06"
        hash_sha256 = "0ea89a83b84b8d20e259bacb6b0d1b176c8327f097c54749ae832981f2a0095a"

    strings:
        /* 样本历史文件名 */
        $name1 = "Lab12-01.dll" ascii nocase
        $name2 = "SampleA.dll" ascii nocase
        $name3 = "victimss.dll" ascii nocase

        /* 可疑 API 组合 */
        $api1 = "CreateThread" ascii
        $api2 = "FlushFileBuffers" ascii
        $api3 = "FreeEnvironmentStringsA" ascii
        $api4 = "MessageBoxA" ascii

        /* PE 头特征 */
        $mz = "This program cannot be run in DOS mode" ascii

    condition:
        /* 必须是 32 位 Windows DLL */
        uint16(0) == 0x5A4D and
        pe.is_dll() and
        pe.machine == pe.MACHINE_I386 and

        (
            /* 精确哈希匹配 */
            hash.sha256(0, filesize) ==
                "0ea89a83b84b8d20e259bacb6b0d1b176c8327f097c54749ae832981f2a0095a"

            or

            /* 行为 + 字符串特征 */
            (
                2 of ($name*) and
                2 of ($api*) and
                $mz
            )
        )
}
