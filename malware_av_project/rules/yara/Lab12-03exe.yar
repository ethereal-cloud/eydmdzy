import "pe"
import "hash"

rule KeyLogger_Win32_Malware
{
    meta:
        description = "Detects Win32 keylogger malware (keyLoger.exe / Lab12-03)"
        author = "Malwareaqqq"
        date = "2026-01-06"
        reference = "VirusTotal SHA256: 9b683d2fda7ca7adcc043e4412271009a0e115ca55f9a718c385a3f46b57ae6b"
        hash_sha256 = "9b683d2fda7ca7adcc043e4412271009a0e115ca55f9a718c385a3f46b57ae6b"

    strings:
        /* 样本常见文件名 */
        $name1 = "keyLoger.exe" ascii nocase
        $name2 = "Lab12-03.exe" ascii nocase
        $name3 = "payload_decrypted.exe" ascii nocase

        /* 键盘钩子相关 API（核心 Keylogger 特征） */
        $hook1 = "SetWindowsHookExA" ascii
        $hook2 = "CallNextHookEx" ascii
        $hook3 = "UnhookWindowsHookEx" ascii

        /* 窗口与消息监控 */
        $win1 = "GetForegroundWindow" ascii
        $win2 = "GetWindowTextA" ascii
        $win3 = "GetMessageA" ascii

        /* 文件与进程相关 */
        $api1 = "CreateFileA" ascii
        $api2 = "GetCurrentProcess" ascii
        $api3 = "GetCommandLineA" ascii

        /* PE DOS Stub */
        $mz = "This program cannot be run in DOS mode" ascii

    condition:
        /* 32 位 Windows EXE（非 DLL） */
        uint16(0) == 0x5A4D and
        pe.machine == pe.MACHINE_I386 and
        not pe.is_dll() and

        (
            /* 精确样本哈希 */
            hash.sha256(0, filesize) ==
                "9b683d2fda7ca7adcc043e4412271009a0e115ca55f9a718c385a3f46b57ae6b"

            or

            /* 行为特征组合 */
            (
                1 of ($name*) and
                all of ($hook*) and
                2 of ($win*) and
                1 of ($api*) and
                $mz
            )
        )
}
