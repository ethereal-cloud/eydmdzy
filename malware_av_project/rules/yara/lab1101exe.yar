rule Lab11_01_exe {
    meta:
        description = "检测Lab11-01.exe GINA劫持安装器"
        
    strings:
        // 关键字符串特征
        $str_gina = "GinaDLL" ascii wide
        $str_msgina32 = "msgina32.dll" ascii wide
        $str_reg_path = "SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon" ascii wide
        
        // 资源节标识
        $str_tgad = "TGAD" ascii wide
        
        // 资源操作API
        $api_find_res = "FindResourceA" ascii
        $api_load_res = "LoadResource" ascii
        $api_lock_res = "LockResource" ascii
        $api_size_res = "SizeofResource" ascii
        
        // 注册表操作API
        $api_reg_create = "RegCreateKeyExA" ascii
        $api_reg_set = "RegSetValueExA" ascii
        
    condition:
        uint16(0) == 0x5A4D and
        filesize < 100KB and
        (
            // GINA相关字符串组合
            ($str_gina and $str_msgina32 and $str_reg_path) or
            // 资源释放特征
            ($str_tgad and 3 of ($api_find_res, $api_load_res, $api_lock_res, $api_size_res)) or
            // 注册表操作 + GINA特征
            (($api_reg_create or $api_reg_set) and ($str_gina or $str_msgina32))
        )
}