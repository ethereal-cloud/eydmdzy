title: 检测Bugscare恶意软件核心破坏行为
id: 9c6b8d3e-2f4a-5b6c-7d8e-9f0a1b2c3d4e
status: test
version: 1.0
description: 检测Bugscare恶意软件的系统级权限操作、强制重启、持久化及视觉骚扰关联行为，基于实验观测证据
author: ynx
date: 2025-11-06
tags:
  - attack.destructive
  - attack.execution
  - attack.persistence
  - attack.t1499  # 服务中断
  - attack.t1059.003  # Windows Command Shell（cmd.exe）
  - attack.t1059.005  # Visual Basic Script（wscript.exe）
logsource:
  product: windows
  service: sysmon  
detection:
  # 1. 核心恶意进程链
  selection_process_chain:
    EventID: 1  # 进程创建
    Image|endswith:
      - '3-BUG32.exe'   # 主样本
      - 'wscript.exe'   # 主样本衍生的脚本执行工具（Process Explorer观测）
      - 'cmd.exe'       # wscript.exe衍生的命令行载体（Process Explorer观测）
      - 'setup_wm.exe'  # 系统媒体组件篡改工具（Process Explorer观测）
      - 'unregmp2.exe'  # 媒体组件配置工具（Process Explorer观测）
    ParentImage|contains:  # 父子进程关系
      - '3-BUG32.exe'   # 主样本→wscript.exe
      - 'wscript.exe'   # wscript.exe→cmd.exe/setup_wm.exe/unregmp2.exe

  # 2. 脚本执行与系统干扰命令
  selection_cmd_exec:
    EventID: 1  # 进程创建
    CommandLine|contains:
      - 'wscript.exe'   # 执行恶意VBS脚本（对应wscript.exe进程）
      - 'setup_wm.exe /install'  # 非授权安装/修改媒体组件
      - 'unregmp2.exe /UpdateWMPVersion'  # 篡改Windows Media Player配置

  # 3. 持久化行为（重启前必执行的注册表修改）
  selection_persistence:
    EventID: 12  # 注册表项创建/修改（Sysmon EventID 12）
    TargetObject|contains:
      - 'HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run'
      - 'HKCU\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run'
    Image|endswith:
      - '3-BUG32.exe'   # 主样本直接修改注册表
      - 'reg.exe'       # 命令行衍生注册表工具
      - 'wscript.exe'   # 脚本衍生注册表修改

  # 排除条件
  exclusion_filter:
    ParentImage|endswith:
      - 'explorer.exe'  # 排除用户手动合法操作
      - 'svchost.exe'   # 排除系统服务合法进程

  # 触发条件：满足任一实证行为且不满足排除条件
  condition: (selection_process_chain or selection_cmd_exec or selection_persistence) and not exclusion_filter

fields:
  - CommandLine
  - Image
  - ParentImage
  - TargetObject
  - UtcTime
  - ProcessId

# 误报说明
falsepositives:
  - 管理员合法使用wscript.exe执行脚本（但通过ParentImage=3-BUG32.exe过滤）
  - 系统正常更新Windows Media Player（无恶意主进程关联，已通过进程链过滤）
  - 合法注册表修改操作（无3-BUG32.exe/wscript.exe关联）

level: critical

references:
  - https://attack.mitre.org/techniques/T1499/  # MITRE ATT&CK服务中断
  - https://attack.mitre.org/techniques/T1059/  # MITRE ATT&CK命令执行
  - https://attack.mitre.org/techniques/T1060/  # MITRE ATT&CK持久化