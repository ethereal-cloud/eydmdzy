title: 检测 MrsMajor 破坏性恶意软件核心行为
id: 9c4f2b1d-3e6a-4df8-a8a2-2c9f7e3b5d12
status: test
version: 1.2
description: 基于实验与样本分析，检测 MrsMajor（别名）样本的典型行为。
author: ynx
date: 2025-11-14
tags:
  - attack.harassment
  - attack.defacement
  - attack.persistence
  - attack.execution
  - attack.t1059.003
  - attack.t1059.005
  - attack.t1499
logsource:
  product: windows
  service: sysmon

detection:
  # 1. 主样本
  selection_main_sample:
    EventID: 1
    Image|contains:
      - 'MrsMajor'
    ParentCommandLine|contains:
      - 'MrsMajor'
    ParentImage|endswith:
      - 'explorer.exe'
      - 'cmd.exe'

  # 2. 主样本衍生 notepad / wscript 或 ParentImage 是 wscript
  selection_spawn_notepad_wscript:
    EventID: 1
    Image|endswith:
      - 'notepad.exe'
      - 'wscript.exe'
      - 'cscript.exe'
    ParentImage|contains:
      - 'MrsMajor'
    ParentImage|endswith:
      - 'wscript.exe'

  # 3. 典型命令行写入记事本 / echo 写入 CON
  selection_notepad_echo_write:
    EventID: 1
    Image|endswith: 'notepad.exe'
    CommandLine|contains:
      - 'echo'
      - '> CON'
      - '>> CON'
      - '&& echo'
      - '>"CON"'

  # 4. 触发 WMP 初始设置或使用 WMP 工具
  selection_wmp_tools:
    EventID: 1
    Image|endswith:
      - 'setup_wm.exe'
      - 'unregmp2.exe'
    ParentImage|contains:
      - 'MrsMajor'

  # 5. VBScript 弹窗（MsgBox 等）包含骚扰文本关键词
  selection_vbs_msgbox:
    EventID: 1
    Image|endswith:
      - 'wscript.exe'
      - 'cscript.exe'
    CommandLine|contains:
      - 'MsgBox'
      - 'MrsMajor'
      - 'Cute Doll'
      - 'Wants TO MEET'

  # 6. shutdown 强制重启命令
  selection_shutdown:
    EventID: 1
    Image|endswith: 'shutdown.exe'
    CommandLine|contains:
      - '-r -t'
      - '/r /t'
      - '-r'
      - '/r'

  # 7. 注册表持久化
  selection_registry_ui_persistence:
    EventID: 13
    TargetObject|contains:
      - 'RunOnce'
      - 'Explorer\\Shell Icons'
      - 'Control Panel\\Cursors'
      - 'Shell Icons'
    Image|endswith:
      - 'reg.exe'
      - 'regedit.exe'
      - 'svchost.exe'
      - 'wscript.exe'
    Details|contains:
      - 'MrsMajor'
      - 'wscript.exe'

  # 8. 恶意图片、图标投放
  selection_file_drop_images:
    EventID: 11
    TargetFilename|endswith:
      - '.jpg'
      - '.jpeg'
      - '.bmp'
      - '.png'
      - '.cur'
      - '.ico'
    TargetFilename|contains:
      - 'skull'
      - 'scare'
      - 'mrsmajor'
    Image|contains:
      - 'MrsMajor'

  # 9. taskkill 被用于终止 notepad
  selection_taskkill_kill_notepad:
    EventID: 1
    Image|endswith: 'taskkill.exe'
    CommandLine|contains:
      - 'notepad.exe'
      - '/im notepad.exe'
      - '/im notepad'
      - '/f /im notepad.exe'
    ParentCommandLine|contains:
      - 'MrsMajor'
      - 'mrsmajor'
    ParentImage|endswith:
      - 'cmd.exe'
      - 'powershell.exe'

  condition: selection_main_sample or selection_spawn_notepad_wscript or selection_notepad_echo_write or selection_wmp_tools or selection_vbs_msgbox or selection_shutdown or selection_registry_ui_persistence or selection_file_drop_images or selection_taskkill_kill_notepad

fields:
  - CommandLine
  - Image
  - ParentImage
  - ParentCommandLine
  - TargetFilename
  - TargetObject
  - Details
  - ProcessId
  - UtcTime
  - User

falsepositives:
  - 管理员脚本或安装程序在安装过程中调用 WMP 初次配置、写 RunOnce 或临时使用 wscript
  - 合法系统维护脚本在受控环境下使用 taskkill 终止 notepad
level: critical

references:
  - https://attack.mitre.org/techniques/T1529/
  - https://attack.mitre.org/techniques/T1547/
  - https://attack.mitre.org/techniques/T1059/
  - https://attack.mitre.org/techniques/T1059/005
