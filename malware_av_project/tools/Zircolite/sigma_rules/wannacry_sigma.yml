title: 检测WannaCry家族勒索软件核心行为
id: 7a9f3b6d-4e2c-4d8a-b7f9-3c1e8e7d2b10
status: test
version: 2.0
description: 检测WannaCry勒索病毒，覆盖进程创建、防御规避、恶意文件释放及文件加密行为
author: ynx
date: 2025-11-06
tags:
  - attack.ransomware
  - attack.defense_evasion
  - attack.persistence
  - attack.data_encryption
  - attack.execution
  - attack.t1059.003  # Windows Command Shell（cmd.exe）
  - attack.t1059.005  # Visual Basic（cscript.exe）
logsource:
  product: windows
  service: sysmon  
detection:
  # 1. 核心恶意进程链
  selection_process_chain:
    EventID: 1  # 进程创建
    Image|endswith:
      - '1-WannaCrypt0r.exe'  # 主样本
      - '@WanaDecryptor@.exe'  # 勒索程序
      - 'taskhsvc.exe'  # Tor通信组件
      - 'attrib.exe'  # 隐藏文件工具
      - 'icacls.exe'  # 权限修改工具
      - 'cmd.exe'  # 命令行载体
      - 'cscript.exe'  # VBS执行工具
    ParentImage|contains:  # 父子进程关系
      - '1-WannaCrypt0r.exe'  # 主样本衍生attrib/icacls/cmd/@WanaDecryptor@.exe/taskhsvc.exe
      - 'cmd.exe'  # cmd.exe衍生cscript.exe

  # 2. 防御规避命令行
  selection_cmd_evasion:
    EventID: 1  # 进程创建
    CommandLine|contains:
      - 'attrib +h'  # 隐藏文件
      - 'icacls . /grant Everyone:F'  # 开放目录权限
      - 'cscript.exe'  # 执行恶意VBS

  # 3. 恶意文件释放
  selection_file_drop:
    EventID: 11  # 文件创建
    TargetFilename|contains:
      - 'taskdl.exe'  # 辅助加密组件（实验中文件夹观测到释放）
      - 'taskse.exe'  # 持久化组件（实验中文件夹观测到释放）
      - '43171762421403.bat'  # 恶意批处理（实验中文件夹观测到释放）
      - '@Please_Read_Me@.txt'  # 勒索信（实验中文件夹观测到释放）
    Image|endswith: '1-WannaCrypt0r.exe'  # 仅主样本释放的文件

  # 4. 文件加密证据
  selection_file_encryption:
    EventID: 11  # 文件创建
    TargetFilename|endswith: '.wnry'  # 加密文件后缀（实验中文件夹观测到多个.wnry文件）
    Image|endswith: '1-WannaCrypt0r.exe'  # 仅主样本加密生成的文件

  # 排除条件
  exclusion_filter:
    ParentImage|endswith:
      - 'explorer.exe'  # 排除用户手动双击的合法程序
      - 'svchost.exe'   # 排除系统服务启动的合法进程

  # 触发条件：满足任一 selection 且不满足 exclusion_filter
  condition: (selection_process_chain or selection_cmd_evasion or selection_file_drop or selection_file_encryption) and not exclusion_filter

fields:
  - CommandLine
  - Image
  - ParentImage
  - TargetFilename
  - UtcTime
  - ProcessId

# 误报说明
falsepositives:
  - 管理员手动使用attrib.exe/icacls.exe（但实验中通过ParentImage=1-WannaCrypt0r.exe已过滤）
  - 合法VBS脚本执行（但实验中通过ParentImage=cmd.exe+Image=cscript.exe+恶意主进程链过滤）

level: critical

references:
  - https://attack.mitre.org/techniques/T1059/  # MITRE ATT&CK命令执行技术
  - https://www.us-cert.gov/ncas/alerts/TA17-132A  # 美国CERT WannaCry官方警报