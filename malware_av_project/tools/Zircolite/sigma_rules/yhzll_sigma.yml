title: 检测“永恒之绿风格恶搞恶意软件”核心破坏行为
id: a1b2c3d4-e5f6-7a8b-9c0d-1e2f3a4b5c6d
status: test
version: 1.0
description: 检测4-yhzll.exe的进程终止、系统界面干扰及恶搞勒索关联行为
author: ynx
date: 2025-11-06
tags:
  - attack.harassment
  - attack.execution
  - attack.t1059.003  # Windows Command Shell（conhost.exe）
  - attack.t1499  # 服务中断
logsource:
  product: windows
  service: sysmon  
detection:
  # 1. 4-yhzll 主样本被创建
  selection_4yhzll:
    EventID: 1
    Image|endswith: 
      - '4-yhzll.exe'
    ParentImage|endswith:
      - 'explorer.exe'

  # 2. taskkill/conhost 被 4-yhzll 衍生
  selection_child_tools:
    EventID: 1
    Image|endswith:
      - 'taskkill.exe'
      - 'conhost.exe'
    ParentImage|contains:
      - '4-yhzll.exe'

  # 3. taskkill 被执行
  selection_cmd_taskkill:
    EventID: 1
    Image|endswith: 'taskkill.exe'
    CommandLine|contains:
      - 'taskkill /f /im explorer.exe'

  # 4. 注册表记录
  selection_registry:
    EventID: 13
    Image|endswith:
      - 'svchost.exe'
    TargetObject|contains:
      - 'InventoryApplicationFile'
      
  exclusion_filter:
    Image|endswith:
      - 'powershell.exe' 
      - 'wmiprvse.exe'

  condition: (selection_4yhzll or selection_child_tools or selection_cmd_taskkill or selection_registry) and not exclusion_filter


fields:
  - CommandLine
  - Image
  - ParentImage
  - UtcTime
  - ProcessId

falsepositives:
  - 管理员或用户手动运行同名合法程序“4-yhzll.exe”
  - 合法的“4-yhzll.exe”程序正常调用taskkill.exe/conhost.exe执行系统维护操作
  - 管理员手动执行“taskkill /f /im explorer.exe”命令修复桌面异常、系统卡顿等问题（ParentImage非4-yhzll.exe）
  - 系统服务（svchost.exe）或正规软件在正常运行时，向“InventoryApplicationFile”注册表项写入合法配置信息
  - 合法的conhost.exe进程被误匹配（ParentImage非4-yhzll.exe）。

level: critical

references:
  - https://attack.mitre.org/techniques/T1059/  # 命令执行
  - https://attack.mitre.org/techniques/T1499/  # 服务中断
  - https://attack.mitre.org/techniques/T1529/  # 骚扰